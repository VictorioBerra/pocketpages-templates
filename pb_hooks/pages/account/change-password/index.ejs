<script server>
  let serverError = null
  let fieldErrors = {}

  if (request.method === 'POST') {

    const client = pb({ request });

    const {
      currentPassword,
      newPassword,
      confirmPassword,
    } = body()

    if (newPassword !== confirmPassword) {
      fieldErrors.password = { message: 'Passwords do not match' }
      serverError = 'Passwords do not match'
    } else {
      try {
        const user = client.collection('users').update(auth.id, {
          oldPassword: currentPassword,
          password: newPassword,
          passwordConfirm: confirmPassword,
        })

        redirect(`/`, {
          message: 'Password changed successfully, you will need to login again.',
        })
      } catch (e) {
        // Try to extract field-level errors from PocketBase error response
        if (e && e.response && e.response.data) {
          fieldErrors = e.response.data
        }
        error = e.message
      }
    }
  }
</script>

<% if (serverError) { %>
  <div class="alert alert-error mb-4">
    <%= serverError %>
  </div>
<% } %>

<form method="post" class="p-6 max-w-sm mx-auto space-y-4">
  <fieldset class="fieldset bg-base-200 border-base-300 rounded-box w-xs border p-4">

    <legend class="fieldset-legend">Change Password</legend>

    <label class="label">Current Password</label>
    <input name="currentPassword" type="password" class="input input-bordered w-full" required />

    <label class="label">New Password</label>
    <input name="newPassword" type="password" class="input input-bordered w-full" required />

    <label class="label">Confirm New Password</label>
    <input name="confirmPassword" type="password" class="input input-bordered w-full" required />

    <button class="btn btn-neutral mt-4">Change Password</button>
  </fieldset>
</form>