<script server>
  const {
    token
  } = params

  let serverError = null
  let fieldErrors = {}

  if (request.method === 'POST') {

    const client = pb();

    const {
      password,
    } = body()

    try {
      client.collection('users').confirmEmailChange(token, password);

      redirect('/auth/login', {
        message: 'Your email has been changed. You will need to login again.',
      })
    } catch (e) {
      // Try to extract field-level errors from PocketBase error response
      if (e && e.response && e.response.data) {
        fieldErrors = e.response.data
      }
      error = e.message
    }
  }
</script>

<%- include('server-error', { serverError }) %>

<form method="post" class="p-6 max-w-sm mx-auto space-y-4">
  <fieldset class="fieldset bg-base-200 border-base-300 rounded-box w-xs border p-4">

    <legend class="fieldset-legend">Change Password</legend>

    <p class="text-sm text-gray-500 mb-4">
      Please enter your password to confirm the email change.
    </p>

    <input name="confirmPassword" type="password" class="input input-bordered w-full" required />
    <button class="btn btn-neutral mt-4">Confirm Email Change</button>
  </fieldset>
</form>