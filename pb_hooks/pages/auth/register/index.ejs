<script server>
  let serverError = null
  let fieldErrors = {}

  if (request.method === 'POST') {
    const {
      identity,
      password
    } = body()

    try {
      createUser(identity, password)
      redirect(`/`, {
        message: 'Registration successful. Please check your email to verify your account.'
      })
    } catch (e) {
      // Try to extract field-level errors from PocketBase error response
      if (e && e.response && e.response.data) {
        fieldErrors = e.response.data
      }
      serverError = e.message || 'Registration failed.'
    }
  }
</script>

<% if (serverError) { %>
<div class="alert alert-error mb-4"><%= serverError %></div>
<% } %>

<form method="post" class="p-6 max-w-sm mx-auto">
  <fieldset class="fieldset bg-base-200 border-base-300 rounded-box w-xs border p-4">
    <legend class="fieldset-legend">Register</legend>

    <label class="label">Email Address</label>
    <input name="identity" value="<%= data.identity %>" type="email" class="input" placeholder="Email" required pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$" minlength="5" maxlength="254" />
    <% if (fieldErrors && fieldErrors.email) { %>
      <p class="validator-hint text-error mt-1"><%= fieldErrors.email.message %></p>
    <% } %>

    <label class="label">Password</label>
    <input name="password" type="password" value="<%= data.password %>" class="input" placeholder="Password" required minlength="8" maxlength="254" />
    <% if (fieldErrors && fieldErrors.password) { %>
      <p class="validator-hint text-error mt-1"><%= fieldErrors.password.message %></p>
    <% } %>

    <button type="submit" class="btn btn-neutral mt-4">Register</button>
  </fieldset>
</form>