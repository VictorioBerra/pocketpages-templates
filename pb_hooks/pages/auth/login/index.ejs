<script server>

  let serverError = null
  let fieldErrors = {}

  if (request.method === 'POST') {
    const {
      identity,
      password,
    } = body()

    try {
      const authData = pb()
        .collection('users')
        .authWithPassword(identity, password);

      if (authData.record.verified) {
        api.signIn(authData)
        redirect(`/`)
      } else {
        // If the user is not verified, show an error message
        serverError = 'Please verify your email address before logging in.'
      }
    } catch (e) {
      // Try to extract field-level errors from PocketBase error response
      if (e && e.response && e.response.data) {
        fieldErrors = e.response.data
      }
      serverError = e.message
    }
  }
</script>

<%- include('server-error', { serverError }) %>

<form method="post" class="p-6 max-w-sm mx-auto">
  <fieldset class="fieldset bg-base-200 border-base-300 rounded-box w-xs border p-4">
    <legend class="fieldset-legend">Login</legend>

    <label class="label">Email</label>
    <input name="identity" value="<%= data.identity %>" type="email" class="input" placeholder="Email" required />
      <% if (fieldErrors && fieldErrors.email) { %>
      <p class="validator-hint text-error mt-1">
        <%= fieldErrors.email.message %>
      </p>
      <% } %>

      <label class="label">Password</label>
      <input name="password" type="password" class="input" placeholder="Password" required />
      <% if (fieldErrors && fieldErrors.password) { %>
      <p class="validator-hint text-error mt-1">
        <%= fieldErrors.password.message %>
      </p>
      <% } %>

      <button type="submit" class="btn btn-neutral mt-4">Login</button>
      <div class="text-center mt-2">
        <a href="/auth/forgot" class="link link-primary">Forgot Password?</a>
      </div>
  </fieldset>
</form>