<script server>
  const {
    token
  } = params

  let serverError = null
  let fieldErrors = {}

  if (request.method === 'POST') {

    const client = pb();

    const {
      newPassword,
      confirmPassword,
    } = body()

    if (newPassword !== confirmPassword) {
      fieldErrors.password = { message: 'Passwords do not match' }
      serverError = 'Passwords do not match'
    } else {
      try {
        client.collection('users').confirmPasswordReset(
          token,
          newPassword,
          confirmPassword,
        );

        redirect('/auth/login', {
            message: 'Your password has been reset, you can now login.',
        })
      } catch (e) {
        // Try to extract field-level errors from PocketBase error response
        if (e && e.response && e.response.data) {
          fieldErrors = e.response.data
        }
        serverError = e.message
      }
    }
  }
</script>

<h2 class="text-3xl font-bold mb-6">Password Reset</h2>

<% if (serverError) { %>
<div class="alert alert-error mb-4"><%= serverError %></div>
<% } %>

<form method="post" class="card bg-base-100 shadow-md p-6 max-w-sm mx-auto space-y-4">

  <div class="form-control">
    <label class="label">
      <span class="label-text">New Password</span>
    </label>
    <input name="newPassword" type="password" class="input input-bordered w-full" required />
  </div>

  <div class="form-control">
    <label class="label">
      <span class="label-text">Confirm New Password</span>
    </label>
    <input name="confirmPassword" type="password" class="input input-bordered w-full" required />
  </div>

  <button type="submit" class="btn btn-primary w-full">Change Password</button>
</form>